<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>KaleidoLAB | Gallerías Clientes</title>
  <!--
  ✦✦✦ NOTAS ✦✦✦
  • Idiomas: ES (por defecto), IT, EN, CA. Selector arriba a la derecha. Se guarda en localStorage.
  • Logo: pon tu archivo en /assets/logo.png (sube la imagen del logo a esa ruta en el repo).
  • Imágenes demo: sube a /media/ estos archivos con estos nombres exactos:
      - /media/retrato.jpg        (la última foto en B/N)
      - /media/negativo.jpg       (la foto en negativo)
      - /media/cianotipia.jpg     (la del laboratorio con la mariposa azul)
  • PIN ejemplo (fácil): Retrato 2024, Galería 1357, Cianotipia 2468.
  • Hosting: GitHub Pages / Netlify / Vercel.
  -->
  <style>
    :root{ --bg:#0b0b0c; --card:#141417; --muted:#9aa0a6; --pri:#e1e1e6; --acc:#ff2a2a; --brand:#ff2a2a; }
    *{box-sizing:border-box}
    html,body{margin:0;background:var(--bg);color:var(--pri);font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
    a{color:inherit;text-decoration:none}
    .wrap{max-width:980px;margin:0 auto;padding:20px}
    header{display:flex;align-items:center;gap:12px}
    .logo{width:44px;height:44px;border-radius:10px;background:#000 url('./assets/logo.png') center/contain no-repeat;border:1px solid #222}
    .title{font-weight:800;letter-spacing:.3px}
    .sub{color:var(--muted);font-size:.95rem}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:16px;margin-top:18px}
    .card{background:var(--card);border:1px solid #222;border-radius:16px;overflow:hidden;display:flex;flex-direction:column}
    .thumb{aspect-ratio:4/3;background:#0f1013 center/cover no-repeat}
    .card .ctr{padding:14px;display:flex;flex-direction:column;gap:6px}
    .badge{font-size:.75rem;color:#cbd5e1}
    .btn{display:inline-flex;align-items:center;justify-content:center;gap:8px;padding:10px 12px;border:1px solid #2a2a2f;border-radius:12px;background:#18181b;cursor:pointer}
    .btn:hover{border-color:#3a3a40}
    .row{display:flex;align-items:center;justify-content:space-between;gap:10px}
    .search{margin:18px 0 6px;display:flex;gap:8px}
    .search input{flex:1;background:#121216;border:1px solid #23232a;border-radius:12px;color:#fff;padding:12px}
    .pill{padding:6px 10px;background:#121216;border:1px solid #222;border-radius:999px;color:#cbd5e1;font-size:.8rem}
    .footer{margin:24px 0;color:#838b95;font-size:.9rem}
    .bar{display:flex;gap:8px;align-items:center;margin-left:auto}
    .icon{width:20px;height:20px}
    .hidden{display:none}
    select.lang{background:#121216;border:1px solid #23232a;border-radius:12px;color:#fff;padding:10px}

    /* Galleria */
    .gallery{margin-top:18px}
    .gallery .head{display:flex;align-items:center;gap:10px}
    .pinlock{margin-top:12px;display:flex;gap:8px}
    .pinlock input{width:160px;background:#111;border:1px solid #222;border-radius:10px;color:#fff;padding:10px;letter-spacing:4px;text-align:center}
    .media{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:12px;margin-top:16px}
    .media a{display:block;border:1px solid #222;border-radius:14px;overflow:hidden}
    .media img, .media video{width:100%;height:auto;display:block}
    .tools{display:flex;gap:8px;margin-top:8px}
    .notice{margin:10px 0;color:#95a0ab}
    .installBadge{border:1px dashed #2a2; padding:6px 10px;border-radius:8px}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="logo" aria-hidden="true"></div>
      <div>
        <div class="title" data-i="title">KaleidoLAB — Galerías Clientes</div>
        <div class="sub" data-i="subtitle">App instalable (PWA) para descargar fotos</div>
      </div>
      <div class="bar">
        <select class="lang" id="langSel" title="Idioma">
          <option value="es">ES</option>
          <option value="it">IT</option>
          <option value="en">EN</option>
          <option value="ca">CA</option>
        </select>
        <button class="btn" id="installBtn" title="Instalar app" disabled>
          <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 3v12"/><path d="m8 11 4 4 4-4"/><path d="M19 21H5"/></svg>
          <span data-i="install">Instalar</span>
        </button>
        <a class="btn" href="#" id="helpBtn" title="Guía"><span data-i="help">Guía</span></a>
      </div>
    </header>

    <div class="search">
      <input id="q" placeholder="Buscar cliente o evento…" />
      <span class="pill" id="count">0</span>
    </div>

    <div id="list" class="grid"></div>

    <section id="viewer" class="gallery hidden"></section>

    <div class="footer" data-i="foot">© KaleidoLAB — App gratuita. Crea un QR para cada galería y compártelo.</div>
  </div>

<script>
/********************** I18N ************************/
const I18N = {
  es:{title:'KaleidoLAB — Galerías Clientes', subtitle:'App instalable (PWA) para descargar fotos', install:'Instalar', help:'Guía', searchPH:'Buscar cliente o evento…', gallery:'Galería', open:'Abrir galería', files:'archivo(s)', pin:'PIN', pinNotice:'Por privacidad, esta galería está protegida con PIN.', unlock:'Desbloquear', back:'Índice', share:'Compartir', qr:'QR', dlAll:'Descargar todo (uno por uno)', zipNote:'Nota: para ZIP, sube un archivo .zip a Drive y añade el enlace como primer elemento.', foot:'© KaleidoLAB — App gratuita. Crea un QR para cada galería y compártelo.'},
  it:{title:'KaleidoLAB — Gallerie Clienti', subtitle:'App installabile (PWA) per scaricare le foto', install:'Installa', help:'Guida', searchPH:'Cerca cliente o evento…', gallery:'Galleria', open:'Apri galleria', files:'file', pin:'PIN', pinNotice:'Per privacy, questa galleria è protetta da PIN.', unlock:'Sblocca', back:'Indice', share:'Condividi', qr:'QR', dlAll:'Scarica tutto (uno per uno)', zipNote:'Nota: per ZIP carica un archivio su Drive e aggiungi il link come primo elemento.', foot:'© KaleidoLAB — App gratuita. Genera un QR per ogni galleria.'},
  en:{title:'KaleidoLAB — Client Galleries', subtitle:'Installable PWA to deliver photos', install:'Install', help:'Help', searchPH:'Search client or event…', gallery:'Gallery', open:'Open gallery', files:'file(s)', pin:'PIN', pinNotice:'For privacy, this gallery is PIN-protected.', unlock:'Unlock', back:'Index', share:'Share', qr:'QR', dlAll:'Download all (one by one)', zipNote:'Note: for ZIP upload a .zip to Drive and add the link as first item.', foot:'© KaleidoLAB — Free app. Generate a QR for each gallery.'},
  ca:{title:'KaleidoLAB — Galeries de clients', subtitle:'Aplicació instal·lable (PWA) per descarregar fotos', install:'Instal·la', help:'Guia', searchPH:'Cerca client o esdeveniment…', gallery:'Galeria', open:'Obre galeria', files:'fitxer(s)', pin:'PIN', pinNotice:'Per privadesa, aquesta galeria està protegida amb PIN.', unlock:'Desbloca', back:'Índex', share:'Comparteix', qr:'QR', dlAll:'Descarrega-ho tot (d'un en un)', zipNote:'Nota: per a ZIP puja un .zip a Drive i afegeix l'enllaç com a primer element.', foot:'© KaleidoLAB — App gratuïta. Genera un QR per a cada galeria.'}
};
let LANG = localStorage.getItem('klb:lang') || 'es';
function applyLang(){
  const L = I18N[LANG] || I18N.es;
  document.documentElement.lang = LANG;
  document.querySelector('[data-i="title"]').textContent = L.title;
  document.querySelector('[data-i="subtitle"]').textContent = L.subtitle;
  document.querySelector('#helpBtn span').textContent = L.help;
  document.querySelector('#installBtn span')?.textContent = L.install;
  document.getElementById('q').placeholder = L.searchPH;
  document.querySelector('[data-i="foot"]').textContent = L.foot;
}

/********************** CONFIG GALLERIES ************************/
const GALLERIES = [
  {
    id: 'retrato',
    title: {es:'Retrato (última foto)', it:'Ritratto (ultima foto)', en:'Portrait (last photo)', ca:'Retrat (última foto)'},
    cover: './media/retrato.jpg',
    pin: '2024',
    files: [ {type:'image', url:'./media/retrato.jpg', name:'Retrato_01.jpg'} ]
  },
  {
    id: 'galeria_negativo',
    title: {es:'Galería (foto en negativo)', it:'Galleria (foto in negativo)', en:'Gallery (negative photo)', ca:'Galeria (foto en negatiu)'},
    cover: './media/negativo.jpg',
    pin: '1357',
    files: [ {type:'image', url:'./media/negativo.jpg', name:'Negativo_01.jpg'} ]
  },
  {
    id: 'cianotipia',
    title: {es:'Cianotipia (la foto que queda)', it:'Cianotipia (la foto che rimane)', en:'Cyanotype (the resulting photo)', ca:'Cianotípia (la foto resultant)'},
    cover: './media/cianotipia.jpg',
    pin: '2468',
    files: [ {type:'image', url:'./media/cianotipia.jpg', name:'Cianotipia_01.jpg'} ]
  }
];

/************** PWA: manifest + service worker *************/
(async function setupPWA(){
  const manifest = {
    name: 'KaleidoLAB — Galerías', short_name: 'KaleidoLAB', start_url: '.', display: 'standalone', background_color: '#0b0b0c', theme_color: '#ff2a2a',
    icons: [ { src: './assets/logo.png', sizes: '256x256', type: 'image/png' } ]
  };
  const blob = new Blob([JSON.stringify(manifest)], {type:'application/manifest+json'});
  const url = URL.createObjectURL(blob);
  const link = document.createElement('link'); link.rel='manifest'; link.href=url; document.head.appendChild(link);

  const swCode = `self.addEventListener('install', e=>{self.skipWaiting();e.waitUntil(caches.open('klb-v1').then(c=>c.addAll(['./'])))});self.addEventListener('activate', e=>self.clients.claim());self.addEventListener('fetch', e=>{e.respondWith((async()=>{try{const r=await fetch(e.request);const c=await caches.open('klb-v1');c.put(e.request,r.clone());return r}catch(err){return caches.match(e.request)}})())});`;
  const swBlob = new Blob([swCode], {type:'text/javascript'});
  const swUrl = URL.createObjectURL(swBlob);
  if('serviceWorker' in navigator){ try{await navigator.serviceWorker.register(swUrl);}catch(err){console.warn('SW fail',err)} }
})();

/***************** UI LOGIC *********************/
const $ = s=>document.querySelector(s);
const listEl = $('#list');
const viewer = $('#viewer');
const search = $('#q');
const count = $('#count');
const helpBtn = $('#helpBtn');
const langSel = document.getElementById('langSel');
langSel.value = LANG; langSel.addEventListener('change',()=>{ LANG = langSel.value; localStorage.setItem('klb:lang', LANG); applyLang(); renderList(search.value); if(location.hash.startsWith('#/g/')) renderGallery(location.hash.split('#/g/')[1]); });
applyLang();

function t(obj){ return typeof obj==='string'? obj : (obj[LANG]||obj.es||Object.values(obj)[0]); }

function renderList(filter=''){
  const L = I18N[LANG];
  const q = filter.trim().toLowerCase();
  const items = GALLERIES.filter(g => t(g.title).toLowerCase().includes(q) || g.id.toLowerCase().includes(q));
  count.textContent = items.length + ' ' + (LANG==='es'?'galería(s)': LANG==='it'?'galleria/e': LANG==='en'?'gallery/ies':'galeria/es');
  listEl.innerHTML = items.map(g=>`
    <article class="card">
      <a href="#/g/${g.id}"><div class="thumb" style="background-image:url('${g.cover}')"></div></a>
      <div class="ctr">
        <div class="row">
          <strong>${t(g.title)}</strong>
          <span class="badge">${L.pin}</span>
        </div>
        <a class="btn" href="#/g/${g.id}" aria-label="${L.open}">${L.open}</a>
      </div>
    </article>
  `).join('');
}

function renderGallery(id){
  const L = I18N[LANG];
  const g = GALLERIES.find(x=>x.id===id);
  if(!g){location.hash='';return}
  const stored = sessionStorage.getItem('pin:'+id) || '';
  const unlocked = stored===g.pin;
  viewer.classList.remove('hidden');
  listEl.classList.add('hidden');
  $('#q').parentElement.classList.add('hidden');

  viewer.innerHTML = `
    <div class="head">
      <a class="btn" href="#" aria-label="${L.back}">
        <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m15 18-6-6 6-6"/></svg>
        ${L.back}
      </a>
      <h2 style="margin:0 6px 0 0">${t(g.title)}</h2>
      <span class="pill">${g.files.length} ${L.files}</span>
      <div class="bar">
        <button class="btn" id="qrBtn" title="QR">${L.qr}</button>
        <button class="btn" id="shareBtn" title="${L.share}">${L.share}</button>
      </div>
    </div>

    ${!unlocked ? `
      <div class="pinlock">
        <input id="pin" maxlength="8" placeholder="${L.pin}" inputmode="numeric" />
        <button class="btn" id="unlockBtn">${L.unlock}</button>
      </div>
      <p class="notice">${L.pinNotice}</p>
    `: `
      <div class="tools">
        <a class="btn" id="dlAll">${L.dlAll}</a>
        <span class="installBadge hidden" id="installHint">PWA</span>
      </div>
      <div class="media">
        ${g.files.map(f=>`
          <a href="${f.url}" download target="_blank" rel="noopener">
            ${f.type==='video' ? `<video src="${f.url}" preload="metadata" controls></video>` : `<img loading="lazy" src="${f.url}" alt="${t(g.title)}">`}
          </a>
        `).join('')}
      </div>
      <p class="notice">${L.zipNote}</p>
    `}
  `;

  viewer.querySelector('a.btn').addEventListener('click', e=>{e.preventDefault();location.hash='';});

  const qrBtn = $('#qrBtn');
  qrBtn?.addEventListener('click', ()=>{
    const url = location.href;
    const qr = `https://api.qrserver.com/v1/create-qr-code/?size=320x320&data=${encodeURIComponent(url)}`;
    const w = window.open('', '_blank');
    w.document.write(`<title>QR — ${t(g.title)}</title><img alt="QR" src="${qr}" style="display:block;margin:20px auto;max-width:90%;height:auto"><p style="text-align:center;font-family:system-ui;color:#333">${url}</p>`);
  });

  const shareBtn = $('#shareBtn');
  shareBtn?.addEventListener('click', async()=>{
    const data = {title: t(g.title), text: 'KaleidoLAB', url: location.href};
    try{ if(navigator.share){await navigator.share(data)} else {await navigator.clipboard.writeText(location.href); alert('Link copiado');} }catch{}
  });

  const installHint = $('#installHint');
  if(window.matchMedia('(display-mode: standalone)').matches===false){installHint?.classList.remove('hidden');}

  $('#unlockBtn')?.addEventListener('click', ()=>{
    const pin = $('#pin').value.trim();
    if(pin===g.pin){sessionStorage.setItem('pin:'+id,pin); renderGallery(id);} else {alert('PIN incorrecto');}
  });

  $('#dlAll')?.addEventListener('click', (e)=>{ e.preventDefault(); for(const f of g.files){ window.open(f.url, '_blank'); } });
}

function route(){ const h = location.hash; if(h.startsWith('#/g/')){ renderGallery(h.split('#/g/')[1]); } else { viewer.classList.add('hidden'); listEl.classList.remove('hidden'); $('#q').parentElement.classList.remove('hidden'); renderList(search.value); } }
search.addEventListener('input', ()=>renderList(search.value));
window.addEventListener('hashchange', route);
renderList();
route();

/************** Install prompt handling **************/
let deferredPrompt=null;
const installBtn = document.getElementById('installBtn');
window.addEventListener('beforeinstallprompt', (e)=>{ e.preventDefault(); deferredPrompt=e; installBtn.disabled=false; });
installBtn.addEventListener('click', async()=>{ if(!deferredPrompt) return; deferredPrompt.prompt(); deferredPrompt=null; installBtn.disabled=true; });

/************** Guía **************/
helpBtn.addEventListener('click', (e)=>{
  e.preventDefault();
  const L = I18N[LANG];
  const msg = (LANG==='es')? `CÓMO USAR

1) Sube /assets/logo.png y /media/*.jpg con esos nombres.
2) Edita la CONFIG (id, título, pin, files).
3) Publica en GitHub Pages.
4) Comparte el enlace y el PIN.
5) Pulsa “${I18N[LANG].install}” para instalar como app.`
  : (LANG==='it')? `COME USARE

1) Carica /assets/logo.png e /media/*.jpg con quei nomi.
2) Modifica la CONFIG (id, titolo, pin, files).
3) Pubblica su GitHub Pages.
4) Condividi link e PIN.
5) Premi “${I18N[LANG].install}” per installare.`
  : (LANG==='en')? `HOW TO USE

1) Upload /assets/logo.png and /media/*.jpg with those names.
2) Edit CONFIG (id, title, pin, files).
3) Publish on GitHub Pages.
4) Share link and PIN.
5) Tap “${I18N[LANG].install}” to install.`
  : `COM UTILITZAR

1) Pujau /assets/logo.png i /media/*.jpg amb aquests noms.
2) Edita la CONFIG (id, títol, pin, fitxers).
3) Publica a GitHub Pages.
4) Comparteix l'enllaç i el PIN.
5) Prem “${I18N[LANG].install}” per instal·lar.`;
  alert(msg);
});
</script>
</body>
</html>
